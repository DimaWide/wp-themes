

# WooCommerce и Calendly Интеграция через Webhooks

Ссылка на страницу: [Personal Brand Styling](https://www.avintagesplendor.com/personal-brand-styling/)

Скриншоты:
 Главная страница - [Personal Brand Styling](https://github.com/DimaWide/wp-themes/blob/main/assets-data/vintage-splendor/screencapture-avintagesplendor-personal-brand-styling.jpg) | [Мобильный вид](https://github.com/DimaWide/wp-themes/blob/main/assets-data/vintage-splendor/screencapture-avintagesplendor-personal-brand-styling-mobile)  
 Страница выбора даты встречи - [Calendly Event Booking.jpg](https://github.com/DimaWide/wp-themes/blob/main/assets-data/screens/calendly-event-booking.jpg)  
 Емейл тимплейт - [Virtual Styling Session + Shopping Links (Gift Card).jpg](https://github.com/DimaWide/wp-themes/blob/main/assets-data/screens/virtual-styling-session-shopping-links-gift-card.jpg)  
 Емейл тимплейт - [Virtual Styling Session + Shopping Links.jpg](https://github.com/DimaWide/wp-themes/blob/main/assets-data/screens/virtual-styling-session-shopping-links.jpg)  
 Емейл тимплейт - [Order Woocommerce.jpg](https://github.com/DimaWide/wp-themes/blob/main/assets-data/screens/screencapture-mail-google-order.jpg)  

## Краткое введение

Функционал представляет собой интеграцию WooCommerce с сервисом Calendly через использование OAuth 2.0 и вебхуков.  
Он автоматизирует процесс обработки событий Calendly для автоматической отправки уведомлений на электронную почту клиентам при успешном приобретении сервисов и услуг WooCommerce и последующем бронировании даты встречи на основе событий в Calendly.

## Возможности

- **OAuth 2.0 Интеграция**: Реализована аутентификация с Calendly через OAuth 2.0 для получения токена доступа и работы с API Calendly.
- **Вебхуки для событий**: Подключение к вебхукам Calendly для получения уведомлений о событиях, таких как создание новых записей (`invitee.created`).
- **Интеграция с WooCommerce**: Функционал поиска заказов в WooCommerce по email клиента, полученному через вебхук, и отправки уведомлений.
- **Отправка email уведомлений**: Автоматическая отправка email сообщений клиентам с использованием шаблонов уведомлений, основанных на типах консультаций.
- **Обновление статуса заказа**: Обновление статуса заказа в WooCommerce после отправки уведомлений клиенту.
- **Логирование действий**: Логирование действий для последующего анализа и мониторинга.

### Алгоритм взаимодействия клиента с сайтом

1. Клиент переходит на страницу услуг и выбирает необходимую услугу.
2. Товар добавляется в корзину с последующим переходом на страницу оформления заказа.
3. При успешном оформлении одной из услуг происходит перенаправление на страницу события Calendly, где указывается дата встречи и бронирование.
4. После этого Calendly отправляет вебхук на сервер, где производится дальнейшая обработка.
5. Вебхук извлекает информацию о клиенте (email) и времени консультации, а затем использует эти данные для поиска заказа в WooCommerce.
6. Если заказ найден в WooCommerce, отправляется email уведомление клиенту с использованием шаблона, в зависимости от типа услуги.

## Как это устроено и работает, детальнее

1. **Настройка приложения в Calendly**:
    - Создается приложение в **Calendly Developer Portal**.
    - Полученные `Client ID` и `Client Secret` используются для реализации авторизации через OAuth 2.0.

2. **OAuth 2.0 аутентификация**:
    - При авторизации пользователь перенаправляется на страницу авторизации Calendly, где он дает разрешение приложению.
    - После авторизации Calendly возвращает код, который используется для получения токена доступа.
    - Токен доступа сохраняется в базе данных для последующих запросов к API Calendly.

3. **Настройка вебхуков**:
    - После получения токена доступа устанавливается вебхук для событий Calendly, для события `invitee.created`.
    - Вебхук отправляет уведомление на сервер, где оно обрабатывается.

4. **Обработка вебхуков**:
    - Реализован REST API эндпоинт в WordPress для обработки уведомлений о событиях от Calendly.
    - Вебхук извлекает информацию о клиенте (email) и времени консультации, а затем использует эти данные для поиска заказа в WooCommerce.

5. **Поиск заказа и отправка email уведомлений**:
    - Если заказ найден в WooCommerce, отправляется email уведомление клиенту с использованием шаблона, в зависимости от типа услуги.
    - В шаблоны добавлены переменные для персонализации (имя клиента, дата события и название услуги).
    - После отправки email обновляется статус заказа в WooCommerce, чтобы отметить успешную отправку уведомления.

6. **Логирование всех действий**:
    - Все действия (получение токена, обработка вебхуков, отправка email, обновление статуса заказа) логируются для анализа и отслеживания работы системы.

## Установка

1. **Получение OAuth данных**: В Calendly Developer Portal создайте приложение, получите `Client ID` и `Client Secret`.
2. **Авторизация через OAuth**: Настройте процесс получения токена доступа через OAuth 2.0.
3. **Настройка вебхуков**: После получения токена настройте вебхуки для получения уведомлений от Calendly.
4. **Интеграция с WooCommerce**: Используйте email клиента для поиска заказов в WooCommerce и отправки уведомлений.
5. **Логирование действий**: Убедитесь, что логирование всех действий включено для анализа.
